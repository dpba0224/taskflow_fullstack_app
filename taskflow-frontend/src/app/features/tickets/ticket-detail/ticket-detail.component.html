@if (loading()) {
  <app-loader />
} @else if (ticket()) {
  <main class="w-full max-w-5xl space-y-8 mx-auto">

    <!-- Header -->
    <header class="flex justify-between items-start mb-8 pt-1 pb-1">
      <div class="flex-1 min-w-0 pt-1 pb-1">
        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">{{ ticket()!.ticketNumber }}</div>

        <!-- Editable Title -->
        @if (editingTitle()) {
          <div class="flex items-center gap-2 pt-1 pb-1">
            <input #titleInput type="text" [(ngModel)]="editTitleValue"
              (keydown.enter)="saveTitle()" (keydown.escape)="cancelEditTitle()"
              (blur)="saveTitle()"
              class="text-3xl font-bold tracking-tight bg-transparent border-b-2 border-pink-500 dark:text-white outline-none w-full" />
          </div>
        } @else {
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight cursor-pointer hover:text-pink-500 dark:hover:text-pink-400 transition-colors pt-1 pb-1"
            (click)="startEditTitle()">
            {{ ticket()!.title }}
          </h1>
        }
      </div>
      <button (click)="deleteTicket()"
        class="flex items-center gap-2 px-4 py-2 rounded-lg border border-red-500/30 text-red-600 dark:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors duration-200 group ml-4 shrink-0">
        <span class="material-icons-round text-sm group-hover:scale-110 transition-transform">delete</span>
        <span class="font-medium">Delete</span>
      </button>
    </header>

    <!-- Properties Grid -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mt-4 mb-10 pt-2 pb-2">
      <!-- Status -->
      <div class="group">
        <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Status</label>
        <div class="relative">
          <select [ngModel]="ticket()!.status" (ngModelChange)="updateField('status', $event)"
            class="w-full appearance-none bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 hover:border-yellow-500 dark:hover:border-yellow-500 px-4 py-2.5 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-500/20 transition-all duration-200 text-gray-700 dark:text-gray-200 font-medium">
            @for (s of statuses; track s) {
              <option [value]="s">{{ statusLabel(s) }}</option>
            }
          </select>
          <span class="material-icons-round absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">expand_more</span>
        </div>
      </div>

      <!-- Priority -->
      <div class="group">
        <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Priority</label>
        <div class="relative">
          <select [ngModel]="ticket()!.priority" (ngModelChange)="updateField('priority', $event)"
            class="w-full appearance-none bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 hover:border-red-500 dark:hover:border-red-500 px-4 py-2.5 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500/20 transition-all duration-200 font-medium"
            [style.color]="priorityColor(ticket()!.priority)">
            @for (p of priorities; track p) {
              <option [value]="p">{{ priorityLabel(p) }}</option>
            }
          </select>
          <span class="material-icons-round absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">expand_more</span>
        </div>
      </div>

      <!-- Type -->
      <div class="group">
        <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Type</label>
        <div class="relative">
          <select [ngModel]="ticket()!.type" (ngModelChange)="updateField('type', $event)"
            class="w-full appearance-none bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 hover:border-blue-500 dark:hover:border-blue-500 px-4 py-2.5 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all duration-200 text-gray-700 dark:text-gray-200 font-medium">
            @for (t of types; track t) {
              <option [value]="t">{{ typeLabel(t) }}</option>
            }
          </select>
          <span class="material-icons-round absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">expand_more</span>
        </div>
      </div>

      <!-- Assignee -->
      <div class="group">
        <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Assignee</label>
        <div class="relative">
          <select [ngModel]="ticket()!.assignee?.id || ''" (ngModelChange)="updateField('assigneeId', $event)"
            class="w-full appearance-none bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 hover:border-green-500 dark:hover:border-green-500 px-4 py-2.5 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500/20 transition-all duration-200 text-gray-700 dark:text-gray-200 font-medium">
            <option value="">Unassigned</option>
            @for (u of users(); track u.id) {
              <option [value]="u.id">{{ u.firstName }} {{ u.lastName }}</option>
            }
          </select>
          <span class="material-icons-round absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">expand_more</span>
        </div>
      </div>
    </section>

    <!-- Metadata -->
    <section class="flex flex-wrap gap-y-3 gap-x-8 items-center text-sm text-gray-500 dark:text-gray-400 mt-4 mb-12 border-b border-gray-200 dark:border-zinc-800 pt-2 pb-8">
      <div class="flex items-center gap-2">
        <span class="material-icons-round text-base text-gray-400">person</span>
        <span>{{ ticket()!.reporter?.firstName }} {{ ticket()!.reporter?.lastName }}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="material-icons-round text-base text-gray-400">schedule</span>
        <span>{{ ticket()!.createdAt | dateFormat }}</span>
      </div>

      <!-- Editable Due Date -->
      <div class="flex items-center gap-2">
        <span class="material-icons-round text-base text-gray-400">event</span>
        <input type="date" [ngModel]="ticket()!.dueDate ? (ticket()!.dueDate | slice:0:10) : ''"
          (ngModelChange)="updateDueDate($event)"
          class="bg-transparent border-none outline-none text-sm text-gray-500 dark:text-gray-400 cursor-pointer hover:text-pink-500 dark:hover:text-pink-400 transition-colors scheme-light dark:scheme-dark" />
      </div>

      <!-- Tags -->
      @if (ticket()!.tags.length) {
        @for (tag of ticket()!.tags; track tag) {
          <div class="px-2.5 py-0.5 rounded-full bg-white dark:bg-zinc-800 border border-gray-200 dark:border-gray-700 text-xs font-medium text-gray-600 dark:text-gray-300">
            {{ tag }}
          </div>
        }
      }
    </section>

    <!-- Editable Tags -->
    <section class="mt-4 mb-10 pt-2 pb-2">
      <div class="flex items-center gap-2 mb-3">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mt-3">Tags</h3>
        <button type="button" (click)="startEditTags()"
          class="text-gray-400 hover:text-pink-500 transition-colors">
          <span class="material-icons-round text-base">edit</span>
        </button>
      </div>
      @if (editingTags()) {
        <div class="flex items-center gap-2">
          <input type="text" [(ngModel)]="editTagsValue"
            (keydown.enter)="saveTags()" (keydown.escape)="cancelEditTags()"
            class="flex-1 px-4 py-2 bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-700 rounded-lg text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-pink-500/50"
            placeholder="e.g. mobile, ios, urgent" />
          <button type="button" (click)="saveTags()"
            class="px-3 py-2 bg-pink-500 text-white rounded-lg text-sm font-medium hover:bg-pink-600 transition-colors">
            Save
          </button>
          <button type="button" (click)="cancelEditTags()"
            class="px-3 py-2 border border-gray-300 dark:border-zinc-700 text-gray-600 dark:text-gray-400 rounded-lg text-sm font-medium hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors">
            Cancel
          </button>
        </div>
      }
    </section>

    <!-- Description -->
    <section class="mt-4 mb-10 pt-2 pb-2">
      <div class="flex items-center gap-2 mb-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Description</h3>
        <button type="button" (click)="startEditDescription()"
          class="text-gray-400 hover:text-pink-500 transition-colors">
          <span class="material-icons-round text-base">edit</span>
        </button>
      </div>
      @if (editingDescription()) {
        <div class="bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl p-5 shadow-sm">
          <textarea [(ngModel)]="editDescriptionValue" rows="6"
            class="w-full bg-transparent border-none outline-none text-gray-700 dark:text-gray-300 resize-y min-h-30 placeholder-gray-400 dark:placeholder-gray-500"
            placeholder="Describe the issue in detail (Markdown supported)"></textarea>
          <div class="flex justify-end gap-2 mt-3 pt-3 border-t border-gray-200 dark:border-zinc-700">
            <button type="button" (click)="cancelEditDescription()"
              class="px-4 py-1.5 text-sm border border-gray-300 dark:border-zinc-700 text-gray-600 dark:text-gray-400 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors">
              Cancel
            </button>
            <button type="button" (click)="saveDescription()"
              class="px-4 py-1.5 text-sm bg-pink-500 text-white rounded-lg font-medium hover:bg-pink-600 transition-colors">
              Save
            </button>
          </div>
        </div>
      } @else {
        <div class="bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl p-5 shadow-sm min-h-20 cursor-pointer hover:border-pink-300 dark:hover:border-pink-800 transition-colors"
          (click)="startEditDescription()">
          <div class="prose prose-sm max-w-none text-gray-700 dark:text-gray-300"
            [innerHTML]="ticket()!.description | markdown"></div>
        </div>
      }
    </section>

    <!-- Attachments -->
    <section class="mt-4 mb-10 pt-2 pb-2">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Attachments</h3>
      <app-file-upload [ticketId]="ticket()!.id" />
    </section>

    <!-- Comments -->
    <section class="mt-4 mb-4 pt-2 pb-2 bg-white dark:bg-zinc-900 border border-gray-200 dark:border-zinc-800 rounded-xl p-5 md:p-8 shadow-sm">
      <app-comment-list [ticketId]="ticket()!.id" />
    </section>

  </main>
}
